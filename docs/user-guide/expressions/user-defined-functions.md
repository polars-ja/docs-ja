# ãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾©é–¢æ•°ï¼ˆUser-defined functionsï¼‰

Polars ã®ã‚¨ã‚¯ã‚¹ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ã¯éå¸¸ã«å¼·åŠ›ã§æŸ”è»Ÿã§ã‚ã‚‹ãŸã‚ã€
ä»–ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚ˆã‚Šã‚‚ã‚«ã‚¹ã‚¿ãƒ  Python é–¢æ•°ã®å¿…è¦æ€§ã¯ã¯ã‚‹ã‹ã«å°‘ãªã„ã¨ã“ã“ã¾ã§ã§ç´å¾—ã—ã¦ã„ãŸã ã‘ãŸã‹ã¨æ€ã„ã¾ã™ã€‚

ãã‚Œã§ã‚‚ãªãŠã€ã‚¨ã‚¯ã‚¹ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹ã‚’ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«æ¸¡ã™ã€
ã¾ãŸã¯ Polars ã§ãƒ‡ãƒ¼ã‚¿ã«å¯¾ã—ã¦ãƒ–ãƒ©ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹é–¢æ•°ã‚’é©ç”¨ã™ã‚‹æ©Ÿèƒ½ãŒå¿…è¦ã§ã™ã€‚

ã“ã®ãŸã‚ã«ã€ä»¥ä¸‹ã®ã‚¨ã‚¯ã‚¹ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ã‚’æä¾›ã—ã¦ã„ã¾ã™:

- `map_batches`
- `map_elements`

## `map_batches` ã‹ã€ãã‚Œã¨ã‚‚ `map_elements` ã‹ã€‚

ã“ã‚Œã‚‰ã®é–¢æ•°ã«ã¯ã€ã©ã®ã‚ˆã†ã«å‹•ä½œã™ã‚‹ã‹ã€ãã—ã¦ãã®çµæœã¨ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã©ã®ã‚ˆã†ãªãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã™ã‹ã¨ã„ã†é‡è¦ãªé•ã„ãŒã‚ã‚Šã¾ã™ã€‚

`map_batches` ã¯ã€ãã®ã¾ã¾ã® `Series` ã‚’ `expression` ã«æ¸¡ã—ã¾ã™ã€‚

`map_batches` ã¯ã€`select` ã¨ `group_by` ã®ä¸¡å¼ã§åŒã˜ãƒ«ãƒ¼ãƒ«ã«å¾“ã„ã¾ã™ã€‚
ã“ã‚Œã¯ã€`Series` ãŒ `DataFrame` ã®ã‚«ãƒ©ãƒ ã‚’è¡¨ã™ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ã€‚ `group_by` å¼ã§ã¯ã€
ãã®ã‚«ãƒ©ãƒ ã¯ã¾ã é›†ç´„ã•ã‚Œã¦ã„ãªã„ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ï¼

`map_batches` ã®ä½¿ç”¨ä¾‹ã¨ã—ã¦ã¯ã€ä¾‹ãˆã°ã‚¨ã‚¯ã‚¹ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ã®ã‚«ãƒ©ãƒ ã‚’ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«æ¸¡ã™ã“ã¨ãŒæŒ™ã’ã‚‰ã‚Œã¾ã™ã€‚
ä»¥ä¸‹ã«ã€ãƒ‹ãƒ¥ãƒ¼ãƒ©ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ¢ãƒ‡ãƒ«ã«ã‚¨ã‚¯ã‚¹ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ã‚«ãƒ©ãƒ ã‚’æ¸¡ã™æ–¹æ³•ã‚’ç¤ºã—ã¾ã™ã€‚

=== ":fontawesome-brands-python: Python"
[:material-api: `map_batches`](https://docs.pola.rs/py-polars/html/reference/expressions/api/polars.Expr.map_batches.html)

```python
df.with_columns([
    pl.col("features").map_batches(lambda s: MyNeuralNetwork.forward(s.to_numpy())).alias("activations")
])
```

=== ":fontawesome-brands-rust: Rust"

```rust
df.with_columns([
    col("features").map(|s| Ok(my_nn.forward(s))).alias("activations")
])
```

`group_by` å¼ã§ `map_batches` ã‚’ä½¿ç”¨ã™ã‚‹ã‚±ãƒ¼ã‚¹ã¯é™ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚ãã‚Œã¯ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ä¸Šã®ç†ç”±ã‹ã‚‰ã®ã¿ä½¿ç”¨ã•ã‚Œã€ç°¡å˜ã«èª¤ã£ãŸçµæœã‚’ã‚‚ãŸã‚‰ã™å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ãã®ç†ç”±ã‚’èª¬æ˜ã—ã¾ã—ã‚‡ã†ã€‚

{{code_block('user-guide/expressions/user-defined-functions','dataframe',[])}}

```python exec="on" result="text" session="user-guide/udf"
--8<-- "python/user-guide/expressions/user-defined-functions.py:setup"
--8<-- "python/user-guide/expressions/user-defined-functions.py:dataframe"
```

ä¸Šã®ã‚¹ãƒ‹ãƒšãƒƒãƒˆã§ã¯ã€`"keys"` ã‚«ãƒ©ãƒ ã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã¾ã™ã€‚ã¤ã¾ã‚Šã€æ¬¡ã®ã‚ˆã†ãªã‚°ãƒ«ãƒ¼ãƒ—ãŒã‚ã‚Šã¾ã™ï¼š

```c
"a" -> [10, 7]
"b" -> [1]
```

ãã®å¾Œã€å³ã¸ã® `shift` æ“ä½œã‚’é©ç”¨ã™ã‚‹ã¨ã€æ¬¡ã®ã‚ˆã†ã«ãªã‚‹ã§ã—ã‚‡ã†ï¼š

```c
"a" -> [null, 10]
"b" -> [null]
```

ãã‚Œã‚’è©¦ã—ã¦ã¿ã¦ã€ä½•ãŒå¾—ã‚‰ã‚Œã‚‹ã‹ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ï¼š

{{code_block('user-guide/expressions/user-defined-functions','shift_map_batches',[])}}

```python exec="on" result="text" session="user-guide/udf"
--8<-- "python/user-guide/expressions/user-defined-functions.py:shift_map_batches"
```

ã‚ã¡ã‚ƒãƒ¼ã€æ˜ã‚‰ã‹ã«é–“é•ã£ãŸçµæœãŒå‡ºã¾ã—ãŸã­ã€‚ã‚°ãƒ«ãƒ¼ãƒ— `"b"` ã¯ã‚°ãƒ«ãƒ¼ãƒ— `"a"` ã‹ã‚‰å€¤ã‚’å¾—ã¦ã—ã¾ã„ã¾ã—ãŸ ğŸ˜µã€‚

ã“ã‚Œã¯ã€é›†ç´„ã™ã‚‹å‰ã« `map_batches` ãŒé–¢æ•°ã‚’é©ç”¨ã™ã‚‹ãŸã‚ã€ã²ã©ãé–“é•ã£ã¦ã—ã¾ã£ãŸã®ã§ã™ã€‚ãã‚Œã¯ã¤ã¾ã‚Šã€å…¨ã‚«ãƒ©ãƒ  `[10, 7, 1]` ãŒã‚·ãƒ•ãƒˆã•ã‚Œã¦ `[null, 10, 7]` ã«ãªã‚Šã€ãã®å¾Œã§é›†ç´„ã•ã‚ŒãŸã¨ã„ã†ã“ã¨ã§ã™ã€‚

ã ã‹ã‚‰ç§ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã¯ã€`map_batches` ã‚’ `group_by` å¼ã§ä½¿ç”¨ã—ãªã„ã“ã¨ã§ã™ã€‚ãã‚ŒãŒå¿…è¦ã§ã‚ã‚Šã€ä½•ã‚’ã—ã¦ã„ã‚‹ã‹ã‚’çŸ¥ã£ã¦ã„ã‚‹å ´åˆã‚’é™¤ãã¾ã™ã€‚

## `map_elements` ã‚’ä½¿ã†

å¹¸ã„ã€å‰ã®ä¾‹ã¯ `map_elements` ã§ä¿®æ­£ã§ãã¾ã™ã€‚ `map_elements` ã¯ã€ãã®æ“ä½œã®ãŸã‚ã®æœ€å°è«–ç†è¦ç´ ã§å‹•ä½œã—ã¾ã™ã€‚

ã¤ã¾ã‚Šï¼š

- `select context` -> å˜ä¸€è¦ç´ 
- `group by context` -> å˜ä¸€ã‚°ãƒ«ãƒ¼ãƒ—

ã—ãŸãŒã£ã¦ã€`map_elements` ã‚’ä½¿ãˆã°ã€ç§ãŸã¡ã®ä¾‹ã‚’ä¿®æ­£ã§ãã‚‹ã¯ãšã§ã™ï¼š

=== ":fontawesome-brands-python: Python"
[:material-api: `map_elements`](https://docs.pola.rs/py-polars/html/reference/expressions/api/polars.Expr.map_elements.html)

{{code_block('user-guide/expressions/user-defined-functions','map_elements',[])}}

```python exec="on" result="text" session="user-guide/udf"
--8<-- "python/user-guide/expressions/user-defined-functions.py:map_elements"
```

ãã—ã¦è¦³å¯Ÿã™ã‚‹ã¨ã€æœ‰åŠ¹ãªçµæœãŒå¾—ã‚‰ã‚Œã¾ã™ï¼ ğŸ‰

## `map_elements` ã® `select` å¼ã§ã®ä½¿ç”¨

`select` å¼ã§ã¯ã€`map_elements` ã‚¨ã‚¯ã‚¹ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ã¯ã‚«ãƒ©ãƒ ã®è¦ç´ ã‚’ Python é–¢æ•°ã«æ¸¡ã—ã¾ã™ã€‚

_æ³¨æ„ã—ã¦ãã ã•ã„ã€‚ã“ã‚Œã¯ Python ã‚’å®Ÿè¡Œã—ã¦ã„ã‚‹ã®ã§ã€é…ããªã‚Šã¾ã™ã€‚_

ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®æœ€åˆã«å®šç¾©ã—ãŸ `DataFrame` ã§ç¶šã‘ã¦ã€
`map_elements` é–¢æ•°ã®ä¾‹ã¨åŒã˜ç›®æ¨™ã‚’é”æˆã™ã‚‹ãŸã‚ã«ã‚¨ã‚¯ã‚¹ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³
API ã‚’ä½¿ç”¨ã™ã‚‹åä¾‹ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

### ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã®è¿½åŠ 

ã“ã®ä¾‹ã§ã¯ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ãª `counter` ã‚’ä½œæˆã—ã€å‡¦ç†ã•ã‚Œã‚‹å„è¦ç´ ã«æ•´æ•° `1` ã‚’åŠ ãˆã¾ã™ã€‚
å„åå¾©ã§ã€ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆã®çµæœãŒè¦ç´ å€¤ã«è¿½åŠ ã•ã‚Œã¾ã™ã€‚

> æ³¨ï¼šã“ã®ä¾‹ã¯ Rust ã§ã¯æä¾›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãã®ç†ç”±ã¯ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ãª `counter` å€¤ãŒä¸¦è¡Œè©•ä¾¡ã•ã‚Œã‚‹ã¨ãã«ãƒ‡ãƒ¼ã‚¿ç«¶åˆã‚’å¼•ãèµ·ã“ã™å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã§ã™ã€‚ãã‚Œã‚’ `Mutex` ã§ãƒ©ãƒƒãƒ—ã—ã¦å¤‰æ•°ã‚’ä¿è­·ã™ã‚‹ã“ã¨ã¯å¯èƒ½ã§ã™ãŒã€ãã‚Œã¯ä¾‹ã®ãƒã‚¤ãƒ³ãƒˆã‚’æ›–æ˜§ã«ã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚ã“ã®å ´åˆã€Python Global Interpreter Lock ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•ãŒã„ãã¤ã‹ã®å®‰å…¨ä¿éšœã‚’æä¾›ã—ã¾ã™ã€‚

{{code_block('user-guide/expressions/user-defined-functions','counter',[])}}

```python exec="on" result="text" session="user-guide/udf"
--8<-- "python/user-guide/expressions/user-defined-functions.py:counter"
```

### è¤‡æ•°ã®ã‚«ãƒ©ãƒ å€¤ã®çµ„ã¿åˆã‚ã›

å˜ä¸€ã® `map_elements` é–¢æ•°ã‚³ãƒ¼ãƒ«ã§ç•°ãªã‚‹ã‚«ãƒ©ãƒ ã®å€¤ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã„å ´åˆã€
`struct` ãƒ‡ãƒ¼ã‚¿ã‚¿ã‚¤ãƒ—ã‚’ä½œæˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã®ãƒ‡ãƒ¼ã‚¿ã‚¿ã‚¤ãƒ—ã¯ã€`struct` å†…ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¨ã—ã¦ãã‚Œã‚‰ã®ã‚«ãƒ©ãƒ ã‚’åé›†ã—ã¾ã™ã€‚
ã—ãŸãŒã£ã¦ã€`"keys"` ã¨ `"values"` ã®ã‚«ãƒ©ãƒ ã‹ã‚‰ struct ã‚’ä½œæˆã™ã‚‹ã¨ã€æ¬¡ã®ã‚ˆã†ãª struct è¦ç´ ãŒå¾—ã‚‰ã‚Œã¾ã™ï¼š

```python
[
    {"keys": "a", "values": 10},
    {"keys": "a", "values": 7},
    {"keys": "b", "values": 1},
]
```

Python ã§ã¯ã€ã“ã‚Œã‚‰ã¯å‘¼ã³å‡ºã—å…ƒã® Python é–¢æ•°ã« `dict` ã¨ã—ã¦æ¸¡ã•ã‚Œã€`field: str` ã«ã‚ˆã£ã¦ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã•ã‚Œã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚Rust ã§ã¯ã€`Struct` ã‚¿ã‚¤ãƒ—ã® `Series` ã‚’å–å¾—ã—ã¾ã™ã€‚struct ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹åŒ–ã•ã‚Œã€ãƒ€ã‚¦ãƒ³ã‚­ãƒ£ã‚¹ãƒˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

{{code_block('user-guide/expressions/user-defined-functions','combine',[])}}

```python exec="on" result="text" session="user-guide/udf"
--8<-- "python/user-guide/expressions/user-defined-functions.py:combine"
```

`Structs` ã«ã¤ã„ã¦ã¯æ¬¡ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§è©³ã—ãèª¬æ˜ã—ã¾ã™ã€‚

### æˆ»ã‚Šå€¤ã¯ï¼Ÿ

ã‚«ã‚¹ã‚¿ãƒ  Python é–¢æ•°ã¯ Polars ã«ã¨ã£ã¦ãƒ–ãƒ©ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã§ã™ã€‚
ã§ã™ã®ã§ã€ã‚ãªãŸãŒä½•ã‚’æ„å›³ã—ã¦ã„ã‚‹ã®ã‹ã‚’æ¨æ¸¬ã—ã€æœ€å–„ã‚’å°½ãã—ã¦ç†è§£ã—ã‚ˆã†ã¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦ã¯ã€ã‚«ã‚¹ã‚¿ãƒ é–¢æ•°ã‚’ã‚ˆã‚Šã‚ˆãåˆ©ç”¨ã™ã‚‹ãŸã‚ã«ç§ãŸã¡ãŒä½•ã‚’ã™ã‚‹ã‹ã‚’ç†è§£ã™ã‚‹ã“ã¨ãŒå½¹ç«‹ã¡ã¾ã™ã€‚

ãƒ‡ãƒ¼ã‚¿ã‚¿ã‚¤ãƒ—ã¯è‡ªå‹•çš„ã«æ¨æ¸¬ã•ã‚Œã¾ã™ã€‚ç§ãŸã¡ã¯æœ€åˆã®é null å€¤ã‚’å¾…ã¡ã€
ãã®å€¤ã‚’ä½¿ç”¨ã—ã¦ `Series` ã®ã‚¿ã‚¤ãƒ—ã‚’æ±ºå®šã—ã¾ã™ã€‚

Python ã®å‹ã‹ã‚‰ Polars ã®ãƒ‡ãƒ¼ã‚¿ã‚¿ã‚¤ãƒ—ã¸ã®ãƒãƒƒãƒ”ãƒ³ã‚°ã¯æ¬¡ã®é€šã‚Šã§ã™ï¼š

- `int` -> `Int64`
- `float` -> `Float64`
- `bool` -> `Boolean`
- `str` -> `String`
- `list[tp]` -> `List[tp]` (å†…éƒ¨ã‚¿ã‚¤ãƒ—ã¯åŒã˜ãƒ«ãƒ¼ãƒ«ã§æ¨æ¸¬)
- `dict[str, [tp]]` -> `struct`
- `Any` -> `object` (ã“ã‚Œã¯å¸¸ã«é¿ã‘ã¦ãã ã•ã„)

Rust ã®å‹ã®ãƒãƒƒãƒ”ãƒ³ã‚°ã¯æ¬¡ã®é€šã‚Šã§ã™ï¼š

- `i32` ã¾ãŸã¯ `i64` -> `Int64`
- `f32` ã¾ãŸã¯ `f64` -> `Float64`
- `bool` -> `Boolean`
- `String` ã¾ãŸã¯ `str` -> `String`
- `Vec<tp>` -> `List[tp]` (å†…éƒ¨ã‚¿ã‚¤ãƒ—ã¯åŒã˜ãƒ«ãƒ¼ãƒ«ã§æ¨æ¸¬)
